---
title: "Analysis of Dose Response"
author: "Ryan Abdella"
date: "January 15, 2015"
output:
  html_document:
    css: ~/Github/Food-Optimization/Scripts/foghorn_edited.css
---


```{r, warning = FALSE, message = FALSE, echo = FALSE}

processedDataPath <- paste("../Data/Processed/", experimentName, sep = "")

source("./wMT_fxns.R")
source("./survival_fxns.R")
source(paste("./", experimentName, ".R", sep = ""))

paste(experimentName)

```
 
## Raw Activity ##

```{r, warning = FALSE, echo = FALSE}

## Pull in all the file associated with the current experiment ##
## and create a data frame containing the raw data.            ##
## Regroup data frame so that it's ordered by strain and       ##
## replicate. Add in strain information.                       ##

file <- dir(path = paste("../Data/Raw/", experimentName, sep = ""), ".txt", full.names = TRUE)

## Need to change to using dplyr instead of plyr. ##
experimentAttributes.df <- processMicrotrackerReport(file)
binSize <- experimentAttributes.df$binSize[1]
time <- experimentAttributes.df$time[1]
numGroups <- experimentAttributes.df$numGroups[1]
numBins <- experimentAttributes.df$numBins[1]
times <- seq(from = binSize, to = time, by = binSize)

raw.df <- generateDataFrameFromFile(experimentAttributes.df)

save(raw.df, file = paste(processedDataPath, "/", experimentName, "_Raw.Rda", sep = ""), ascii = TRUE)

ordered.df <- raw.df[order(raw.df$col, raw.df$row, raw.df$time), ]

ordered.df$strain <- factor(ordered.df$col, labels = strains)
ordered.df$conc <- factor(ordered.df$row, labels = conc)

save(ordered.df, file = paste(processedDataPath, "/", experimentName, "_Processed.Rda", sep = ""), ascii = TRUE)

```

```{r Raw, warning = FALSE, message = FALSE, echo = FALSE, fig.path = paste("Scripts/", processedDataPath, "/", experimentName, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(ordered.df) + aes(x = time, y = activity) + geom_line() + facet_grid(conc ~ strain) +
  labs(x = "Time (minutes)", y = "Raw Activity")

```

## Cleaned Data ##

```{r, warning = FALSE, message = FALSE, echo = FALSE}

## Remove both columns and individual wells that were contaminated. ##

cleaned.df <- ordered.df
cleaned.df$activity[(cleaned.df$col %in% colRemove)] <- NA
cleaned.df$activity[(cleaned.df$row %in% rowRemove)] <- NA
for(i in 1:length(wellRemove$row)) {
  cleaned.df$activity[cleaned.df$row == wellRemove$row[i] & cleaned.df$col == wellRemove$col[i]] <- NA
}

save(cleaned.df, file = paste(processedDataPath, "/", experimentName, "_Cleaned2.Rda", sep = ""), ascii = TRUE)

```

```{r Cleaned, warning = FALSE, message = FALSE, echo = FALSE, fig.path = paste("Scripts/", processedDataPath, "/", experimentName, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(cleaned.df) + aes(x = time, y = activity) + geom_line() + facet_grid(conc ~ strain) +
  labs(x= "Time (minutes)", y = "Raw Activity")

```

## Well Normalized Data ##

```{r, warning = FALSE, message = FALSE, echo = FALSE}

## Normalize activity data by the maximum activity of each well. ##
## NEED TO ADD NORMALIZING BY THE NUMBER OF WORMS SORTED.        ##

well.df <- cleaned.df %>%
  group_by(strain, row) %>%
  mutate(norm.act = 100 * activity / max(activity, na.rm = TRUE))

well.df <- ungroup(well.df)

save(well.df, file = paste(processedDataPath, "/", experimentName, "_Normalized.Rda", sep = ""), ascii = TRUE)

```

```{r Normalized, warning = FALSE, message = FALSE, echo = FALSE, fig.path = paste("Scripts/", processedDataPath, "/", experimentName, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(well.df) + aes(x = time, y = norm.act) + ylim(0, 100) + geom_line() + facet_grid(conc ~ strain) +
  labs(x = "Time (minutes)", y = "Normalized Activity")

```

## Setting Top of Curve by Well ##

```{r, warning = FALSE, message = FALSE, echo = FALSE}

# THIS IS NOT WORKING #

well.df <- well.df %>%
  group_by(strain, row) %>%
  mutate(max.sum = time[which.max(norm.act)[1]]) #%>%
  #group_by(row) %>%
  #mutate(adjusted.activity = ifelse(time < max.sum, 100, norm.act))

well.df$adjusted.activity <- rep(0, length(well.df$time))

for (i in 1:length(well.df$strain)) {
  well.df$adjusted.activity[i] <- ifelse(well.df$time[i] < well.df$max.sum[i], 100, well.df$norm.act[i])
}

well.df <- ungroup(well.df)
  
```

```{r Adjusted, warning = FALSE, message = FALSE, echo = FALSE, fig.path = paste("Scripts/", processedDataPath, "/", experimentName, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(well.df) + aes(x = time, y = adjusted.activity) + geom_line() + facet_grid(conc ~ strain) +
  labs(x = "Time (minutes)", y = "Adjusted Activity")

```

## Well Curve Fitting ##

```{r, warning = FALSE, message = FALSE, echo = FALSE}

well_params.df <- data.frame(strain = rep(strains, each = replicates), row = rep(levels(well.df$row), nStrains), bparam = rep(0, nStrains * replicates), cparam = rep(0, nStrains * replicates))

l = 1

for (x in levels(well.df$strain)) {
  for (y in levels(well.df$row)) {
    if (!(is.na(well.df$norm.act[well.df$row == y & well.df$strain == x]))[1] == TRUE) {
      temp <- nlm(well_twoplog, c(2, 30), well.df, y, x)[["estimate"]]
      well_params.df$bparam[l] <- temp[1]
      well_params.df$cparam[l] <- temp[2]
    }
    l = l + 1
  }
}

save(well_params.df, file = paste(processedDataPath, "/", experimentName, "_Well_Params.Rda", sep = ""), ascii = TRUE)

print(well_params.df)

```

## 2 Parameter Logistic Function Fits by Well ##

```{r, warning = FALSE, message = FALSE, echo = FALSE}

draw_twoplog <- function(bparam, cparam) {
  return((100 / (1 + ((times / cparam) ^ bparam))))
}

well_survivals.df <- data.frame(time = times)

l <- 2

for (x in levels(well.df$strain)) {
  for (y in levels(well.df$row)) {
    well_survivals.df[l] <- draw_twoplog(well_params.df$bparam[well_params.df$strain == x & well_params.df$row == y], well_params.df$cparam[well_params.df$strain == x & well_params.df$row == y])
    l <- l + 1
  }
}

well_survivals.df <- well_survivals.df %>% gather(strain, yvalue, 2:97)
well.df$yvalue <- well_survivals.df$yvalue

for (i in 1:length(well.df$yvalue)) {
  if (is.na(well.df$norm.act[i]) == TRUE) {
    well.df$yvalue[i] <- NA
  }
}

```

```{r Well_Fits, warning = FALSE, message = FALSE, echo = FALSE, fig.path = paste("Scripts/", processedDataPath, "/", experimentName, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(well.df) + geom_line(aes(x = time, y = norm.act)) + ylim(0, 100) + geom_line(aes(x = time, y = yvalue, color = "red")) + facet_grid(conc ~ strain)

```
